<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>用户信息</title>

    <link rel="stylesheet" href="../css/userinfo.css">
    <link rel="stylesheet" href="../layui/css/layui.css" media="all">

    <script src="../js/jquery.min.js" type="text/javascript"></script>
    <script src="../js/userinfo.js"></script>

</head>
<body>
<div class="userinfo">
    <div class="layui-btn layui-btn-lg layui-btn-normal" style="background-color: #009688" id="add"><a>新增</a></div>
    <div class="layui-btn layui-btn-lg layui-btn-danger" style="background-color: #0082c8" lay-filter="del" id="mod" lay-event="del"><a>修改</a></div>
    <div class="layui-btn layui-btn-lg layui-btn-danger" style="background-color: #EA5514" lay-filter="del" id="del" lay-event="del"><a>删除</a></div>
</div>

<div id="user-content" class="user-content" style="background-color: white;display: none">
    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 50px;">
        <legend>新增用户</legend>
    </fieldset>
    <form class="layui-form layui-form-pane" lay-filter="userinfo" id="formadd" method="post">
        <div class="layui-form-item">
            <label class="layui-form-label">用户姓名</label>
            <div class="layui-input-block">
                <label>
                    <input type="text" name="username" id="username" autocomplete="off" lay-verify="required" placeholder="请输入用户名" class="layui-input" maxlength="7">
                </label>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">用户密码</label>
            <div class="layui-input-block">
                <label>
                    <input type="password" name="password" id="password" autocomplete="off" lay-verify="required" placeholder="请输入用户密码" class="layui-input" maxlength="7">
                </label>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">邮箱</label>
            <div class="layui-input-inline">
                <label>
                    <input type="email" name="email" id="email" lay-verify="required" placeholder="请输入邮箱" autocomplete="off" class="layui-input">
                </label>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">年龄</label>
            <div class="layui-input-inline">
                <label>
                    <input type="number" name="age" id="age" placeholder="请输入年龄" lay-verify="required" autocomplete="off" class="layui-input" min="0" max="100" maxlength="32">
                </label>
            </div>
        </div>
        <div class="layui-form-item" pane="">
            <label class="layui-form-label">性别</label>
            <div class="layui-input-block">
                <input type="radio" name="sex"  id="sex-man" value="男" title="男" checked="">
                <input type="radio" name="sex" id="sex-women" value="女" title="女">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">岗位职称</label>
            <div class="layui-input-block">
                <label>
                    <input type="text" name="position" id="position" lay-verify="required" autocomplete="off" placeholder="请输入职称" class="layui-input" maxlength="12">
                </label>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">所属业务线</label>
            <div class="layui-input-block">
                <label>
                    <input type="text" name="line" id="line" lay-verify="required" autocomplete="off" placeholder="请输入业务线" class="layui-input" maxlength="12">
                </label>
            </div>
        </div>
        <div class="layui-form-item">
            <button type="button" lay-event="layadd" class="layui-btn" id="LAY-component-form-setval" lay-submit lay-filter="addinfo">提&emsp;&emsp;交</button>
            <button type="reset" class="layui-btn layui-btn-primary" id="close">关&emsp;&emsp;闭</button>
        </div>
    </form>
</div>
<div class="user-data">
    <table id="usertable" lay-filter="usersinfo"></table>
</div>


<script src="../layui/layui.js"></script>
<script>
    layui.use('table', function(){
        let table = layui.table;
        const $ = layui.jquery;
        //第一个实例
        table.render({
            elem: '#usertable'
            ,url: '/query/userdata' //数据接口
            ,page: true //开启分页
            ,loading:true
            ,id:'usersinfo'
            ,cols: [[ //表头
                {type:'checkbox'}
                ,{type: 'numbers',title: '序号',align:'center',width:60}
                ,{field: 'name', title: '用户名', sort: true}
                ,{field: 'sex', title: '性别',width:80}
                ,{field: 'age', title: '年龄',width:80}
                ,{field: 'email', title: '邮箱'}
                ,{field: 'jobs', title: '岗位职称'}
                ,{field: 'lines', title: '业务线'}
                ,{field: "CreationTime", title: '创建时间',templet:"<div>{{layui.util.toDateString(d.updateTime, 'yyyy-MM-dd HH:mm:ss')}}</div>"}
            ]]
        });

        $(document).on('click','#LAY-component-form-setval',function (){
            setTimeout(function (){table.reload('usersinfo',{where:{}, page:{curr:1}})},1000)
        });



        const json = {};
        let checkStatus;

        table.on('checkbox(usersinfo)',function (){

            checkStatus = table.checkStatus('usersinfo');
            const  namelist=[];
            for(let i=0; i<checkStatus.data.length; i++){
                namelist.push(checkStatus.data[i].name)
            }
            json["name"]=namelist;
            json["count"]=checkStatus.data.length;
        });

        $(document).on('click','#mod',function (){
            if(checkStatus.data.length!==1){
                layer.confirm("请勾选仅一个用户进行编辑！", {
                    btn: ['确认']
                });
                return false;
            }else {
                document.getElementById("user-content").style.display="block";
                document.getElementById("username").value=checkStatus.data[0].name;
                document.getElementById("username").setAttribute("style","background-color:#e6e6e6");
                document.getElementById("age").value=checkStatus.data[0].age;
                document.getElementById("age").setAttribute("style","background-color:#e6e6e6");
                document.getElementById("position").value=checkStatus.data[0].jobs;
                document.getElementById("position").setAttribute("style","background-color:#e6e6e6");
                document.getElementById("email").value=checkStatus.data[0].email;
                document.getElementById("line").value=checkStatus.data[0].lines;
                document.getElementsByClassName("sex").value=checkStatus.data[0].sex;
                $('#username').attr("readonly",true);
                $('#age').attr("readonly",true);
                $('#position').attr("readonly",true);



                $("#LAY-component-form-setval").click(function() {



                    const User = {};
                    User["name"]=checkStatus.data[0].name;
                    User["password"]=$("#password").val();
                    User["email"]=$("#email").val();
                    User["line"]=$("#line").val();

                    if(User["password"].length===0){
                        layer.confirm("密码项没有输入值！", {
                            btn: ['确认']
                        });
                        return false;
                    }

                    layer.open({
                        content: '确认修改用户账号信息吗？',
                        yes: function(index){
                            layer.close(index);
                            $.ajax({
                                url:"/mod/userinfo",
                                type:"POST",
                                datatype:"JSON",
                                contentType:"application/json",
                                data:JSON.stringify(User),
                                success:function (data) {
                                    if(data.code==="0"){
                                        layer.confirm("修改用户成功！", {
                                            btn: ['确认']
                                        });
                                        document.getElementById("user-content").style.display="none";
                                        document.getElementById("username").value="";
                                        document.getElementById("password").value="";
                                        document.getElementById("email").value="";
                                        document.getElementById("age").value="";
                                        document.getElementById("position").value="";
                                        document.getElementById("line").value="";

                                        setTimeout(function (){table.reload('usersinfo',{where:{}, page:{curr:1}})},1000);
                                        checkStatus.data.length = 0;
                                        return true;
                                    }else {
                                        layer.confirm(data.errormsg, {
                                            btn: ['确认']
                                        });
                                        return false;

                                    }

                                }
                            })

                        }
                    });
                });


            }
        });

        $(document).on('click','#add',function (){

            $('#username').attr("readonly",false).css("background-color","#FFFFFF");
            $('#age').attr("readonly",false).css("background-color","#FFFFFF");
            $('#position').attr("readonly",false).css("background-color","#FFFFFF");
            document.getElementById("username").value="";
            document.getElementById("age").value="";
            document.getElementById("position").value="";
            document.getElementById("email").value="";
            document.getElementById("line").value="";


            $("#LAY-component-form-setval").click(function() {

                if($("#username").val().length===0){
                    layer.confirm("用户名项没有输入值！", {
                        btn: ['确认']
                    });
                    return false;
                }

                if($("#password").val().length===0){
                    layer.confirm("密码项没有输入值！", {
                        btn: ['确认']
                    });
                    return false;
                }

                if($("#email").val().length===0){
                    layer.confirm("邮箱项没有输入值！", {
                        btn: ['确认']
                    });
                    return false;
                }
                if($("#age").val().length===0){
                    layer.confirm("年龄项没有输入值！", {
                        btn: ['确认']
                    });
                    return false;
                }
                if($("#position").val().length===0){
                    layer.confirm("岗位职称项没有输入值！", {
                        btn: ['确认']
                    });
                    return false;
                }
                if($("#line").val().length===0){
                    layer.confirm("所属业务线项没有输入值！", {
                        btn: ['确认']
                    });
                    return false;
                }

                $.ajax({
                    url:"/add/userinfo",
                    type:"POST",
                    datatype:"JSON",
                    data: $('#formadd').serialize(),
                    success:function (data) {
                        if(data.code==="0"){

                            layer.open({
                                content: '新增用户成功！',
                                yes: function(index, layero){
                                    layer.close(index);

                                    document.getElementById("user-content").style.display="none";
                                    document.getElementById("username").value="";
                                    document.getElementById("password").value="";
                                    document.getElementById("email").value="";
                                    document.getElementById("age").value="";
                                    document.getElementById("position").value="";
                                    document.getElementById("line").value="";

                                }
                            });
                            return true;
                        }else {

                            layer.open({
                                content: data.errormsg,
                                yes: function(index, layero){
                                    layer.close(index);
                                }
                            });
                            return false;

                        }

                    }
                })

            });

        });

        $(document).on('click','#close',function (){

            $('#username').attr("readonly",false).css("background-color","#FFFFFF");
            $('#age').attr("readonly",false).css("background-color","#FFFFFF");
            $('#position').attr("readonly",false).css("background-color","#FFFFFF");
            document.getElementById("username").value="";
            document.getElementById("age").value="";
            document.getElementById("position").value="";
            document.getElementById("email").value="";
            document.getElementById("line").value="";

            return true;

        });

        $(document).on('click','#del',function (){
            if(checkStatus.data.length < 1){
                layer.confirm("请勾选至少一个用户进行删除！", {
                    btn: ['确认']
                });
                return false;
            }else {

                layer.open({
                    content: '确认删除用户账号吗？',
                    yes: function(index){
                        layer.close(index);
                        $.ajax({
                            url:"/del/userinfo",
                            type:"POST",
                            datatype:"JSON",
                            contentType:"application/json",
                            data:JSON.stringify(json),
                            success:function (data) {
                                if(data.code==="0"){
                                    layer.confirm("删除用户成功！", {
                                        btn: ['确认']
                                    });
                                    setTimeout(function (){table.reload('usersinfo',{where:{}, page:{curr:1}})},1000);
                                    checkStatus.data.length = 0;
                                    return true;
                                }else {
                                    layer.confirm(data.errormsg, {
                                        btn: ['确认']
                                    });
                                    return false;

                                }

                            }
                        })

                    }
                });

            }
        });



    });

</script>

</body>
</html>